define(function(require){function e(){this.m_iPerPage=0,this.m_aItems=[],this.m_iCurPage=0,this.m_iTotalPage=0}var t=require("jquery");require("resize"),e.prototype={addItems:function(e){$.merge(this.m_aItems,e),0===this.m_iCurPage&&this.m_aItems.length&&(this.m_iCurPage=1),this.m_iTotalPage=Math.ceil(this.m_aItems.length/this.m_iPerPage)},setPerPage:function(e){1>e||(this.m_iPerPage=e,this.m_iTotalPage=Math.ceil(this.m_aItems.length/e),0===this.m_iCurPage&&(this.m_iCurPage=1),this.m_iCurPage>this.m_iTotalPage&&(this.m_iCurPage=this.m_iTotalPage))},clear:function(){this.m_aItems.length=0,this.m_iCurPage=0,this.m_iTotalPage=0},getCurrentPageItems:function(){var e=[];if(0===this.m_iCurPage)return e;var t=(this.m_iCurPage-1)*this.m_iPerPage,i=this.m_iCurPage*this.m_iPerPage;i>this.m_aItems.length&&(i=this.m_aItems.length);for(var n=t;i>n;n++)e.push(this.m_aItems[n]);return e},getNextPage:function(){return this.m_iCurPage<this.m_iTotalPage&&this.m_iCurPage++,this.getCurrentPageItems()},getPrevPage:function(){return this.m_iCurPage>1&&this.m_iCurPage--,this.getCurrentPageItems()},getFirstPage:function(){return this.m_iCurPage=1,this.getCurrentPageItems()},getLastPage:function(){return this.m_iCurPage=this.m_iTotalPage,this.getCurrentPageItems()}},function(t){t.fn.table=function(i){function n(){0===f.m_iCurPage?(y.prop("disabled",!0),T.prop("disabled",!0),L.prop("disabled",!0),D.prop("disabled",!0)):(1===f.m_iCurPage?(y.prop("disabled",!0),T.prop("disabled",!0)):(y.prop("disabled",!1),T.prop("disabled",!1)),f.m_iCurPage===f.m_iTotalPage?(L.prop("disabled",!0),D.prop("disabled",!0)):(L.prop("disabled",!1),D.prop("disabled",!1))),_.html(p.lan.total+" "+f.m_aItems.length+" "+p.lan.item),I.html(f.m_iCurPage+"/"+f.m_iTotalPage)}function a(){var e=r.height()-s.outerHeight(!0)-u.outerHeight(!0);if(l.children("div").length*P>=e)l.height(e),c.hide();else{l.css("height","");var t=e-l.outerHeight(!0);c.show().height(t),c.find("span").height(t)}}function o(e,i){l.empty(),i&&p.showCheckbox&&s.find(":checkbox").eq(0).prop("checked",!1),t.each(e,function(e,i){var n=t("<div class='table-row'></div>"),a=l.children("div").length;p.showCheckbox&&(n.append("<span class='table-cell' style='width:"+h+"px;'><input type='checkbox' class='checkbox'/></span>"),n.find(":checkbox").eq(0).change(function(){l.find(":checkbox:checked").length===l.find(":checkbox:enabled").length?s.find(":checkbox").eq(0).prop("checked",!0):s.find(":checkbox").eq(0).prop("checked",!1),p.onChecked&&p.onChecked(l.find(":checkbox:checked").length)})),p.showIndex&&(a=(f.m_iCurPage-1)*f.m_iPerPage+a,n.append("<span class='table-cell' style='width:"+g+"px;'>"+(a+1)+"</span>")),t.each(i,function(e,i){if(!(e>=p.header.length)&&"data"!==p.header[e].type){var o=t("<span class='table-cell'"+(p.header[e].hide?"style='display:none;'":"")+"></span>");if(""!==p.header[e].width&&o.css("width",p.header[e].width+"px"),""!==C[e])"disabled"!==C[e]&&C[e].is("input")?o.text(i):o.data("value",i).text(p.header[e].type[i]),"disabled"!==C[e]&&o.bind({click:function(){if(!d){window.getSelection&&(window.getSelection?window.getSelection().removeAllRanges():window.document.selection.empty());var i=C[e].clone(!0),n=i.is("input");if(n)i.val(t(this).text()),i.css({width:t(this).width()-2+"px",height:t(this).height()-2+"px","line-height":t(this).height()-2+"px"});else{var o=t(this).data("value");i.find("option[value='"+o+"']").prop("selected",!0),i.css({width:t(this).width()+"px"})}if(i.bind("blur",{rowIndex:a,cellIndex:e},function(i){var o=!0;if(p.onBlur&&(o=p.onBlur(this,a,e),o===void 0&&(o=!0)),o){var r=t(this).val(),s=t(this).parent();if(n)t(this).remove(),s.text(r);else{var l=t(this).find("option:selected").text();t(this).remove(),s.text(l).data("value",r)}f.m_aItems[i.data.rowIndex][i.data.cellIndex]=r}}),t(this).empty().append(i),i.focus(),n){var r=i.get(0),s=i.val().length;if(document.selection){var l=r.createTextRange();l.moveStart("character",s),l.collapse(),l.select()}else"number"==typeof r.selectionStart&&"number"==typeof r.selectionEnd&&(r.selectionStart=r.selectionEnd=s)}}},mouseenter:function(){t(this).addClass("edit-cell-enter");var e=t("<div class='cell-border'></div>");e.css({height:t(this).height()-2+"px",width:t(this).width()-2+"px"}),t(this).append(e)},mouseleave:function(){t(this).removeClass("edit-cell-enter").children("div.cell-border").remove()}}).addClass("edit-cell");else if(t.isPlainObject(i))t.each(i,function(e,t){return o.text(t),!1});else if("button"===p.header[e].type){var r=t("<button class='btn'>"+p.header[e].display+"</button>");r.bind("click",function(){p.header[e].callback&&p.header[e].callback(i)}),o.html(r)}else"string"==typeof i?o.text(i):o.html(i);n.append(o)}}),0===a%2?n.addClass("table-even"):n.addClass("table-odd"),n.bind({click:function(){var e=this;t(this).hasClass("table-select")||(t(this).siblings(".table-select").removeClass("table-select"),t(this).removeClass("table-enter").addClass("table-select"),n.children("span").each(function(){return t(this).data("events")&&t(this).data("events").click?(0===t(e).children("span").children(":input:not(:checkbox)").length&&t(this).click(),!1):void 0}),p.onSelect&&p.onSelect(a))},mouseenter:function(){t(this).hasClass("table-select")||t(this).addClass("table-enter")},mouseleave:function(){t(this).removeClass("table-enter")}}),l.append(n),n.find("span").each(function(){this.scrollWidth>t(this).width()&&t(this).attr("title",t(this).text())})}),p.showPage&&n(),a()}var r,s,l,c,u,d,p=t.extend({header:[],showCheckbox:!1,showIndex:!1,showPage:!1,perPage:0,lan:{index:"Index",total:"total",item:"item"},onSelect:null,onBlur:null,onChecked:null},i),m=this,h=20,g=40,f=new e;t(m).empty(),r=t("<div class='table'></div>"),t(m).append(r);var v=t("<div class='table-row'><span class='table-cell' style='width: 100px;'>&nbsp;</span></div>");r.append(v);var S=17,P=v.outerHeight(!0),b=v.width()-2-S;v.remove(),s=t("<div class='table-header'></div>"),r.append(s),p.showCheckbox&&(b-=h+1,s.append("<span class='table-cell' style='width:"+h+"px;'><input type='checkbox' class='checkbox'/></span>"),s.find(":checkbox").eq(0).bind("change",function(){var e=this;l.find(":checkbox").each(function(){t(this).prop("disabled")||(t(this).prop("checked",t(e).prop("checked")),p.onChecked&&p.onChecked(l.find(":checkbox:checked").length))})})),p.showIndex&&(b-=g+1,s.append("<span class='table-cell' style='width:"+g+"px;'>"+p.lan.index+"</span>"));var C=[];if(t.each(p.header,function(e,i){if(p.header[e]=t.extend({display:"",width:"",type:"",disabled:!1,percentWidth:"",callback:null},i),"data"===p.header[e].type)return C.push(""),void 0;var n=p.header[e],a=t("<span class='table-cell'"+(p.header[e].hide?" style='display:none;'":"")+">"+n.display+"</span>");if(s.append(a),""!==n.percentWidth&&(n.width=Math.floor(parseInt(n.percentWidth,10)*b/100)+""),""!==n.width&&a.css("width",n.width+"px"),a[0].scrollWidth>a.width()&&a.attr("title",a.text()),""!==n.type)if(n.disabled)C.push("disabled");else if("text"===n.type){var o=t("<input type='text' />").bind({click:function(e){e.stopPropagation()},keydown:function(e){13===e.which&&(e.preventDefault(),t(this).blur())}});n.maxlength&&o.attr("maxlength",n.maxlength),C.push(o)}else if(t.isPlainObject(n.type)){var r=t("<select></select>");t.each(n.type,function(e,t){r.append("<option value='"+e+"'>"+t+"</option>")}),r.bind({click:function(e){e.stopPropagation()},keydown:function(e){13===e.which&&(e.preventDefault(),t(this).blur())}}),C.push(r)}else C.push("");else C.push("")}),l=t("<div class='table-body'></div>"),r.append(l),c=t("<div class='table-remain'></div>"),p.showCheckbox&&c.append("<span class='table-cell' style='width:"+h+"px;'>&nbsp;</span>"),p.showIndex&&c.append("<span class='table-cell' style='width:"+g+"px;'>&nbsp;</span>"),t.each(p.header,function(e){if("data"!==p.header[e].type){var i=t("<span class='table-cell'"+(p.header[e].hide?" style='display:none;'":"")+">&nbsp;</span>");c.append(i),""!==p.header[e].width&&i.css("width",p.header[e].width+"px")}}),r.append(c),u=t("<div class='table-footer' align='right'></div>"),p.showPage){var _=t("<label class='table-page-label'>"+p.lan.total+" 0 "+p.lan.item+"</label>"),I=t("<label class='table-page-label'>"+f.m_iCurPage+"/"+f.m_iTotalPage+"</label>"),y=t("<button class='btn'><label>&lt;&lt;</label></button>");y.bind("click",function(){t(this).prop("disabled")||o(f.getFirstPage(),!0)});var T=t("<button class='btn'><label>&lt;</label></button>");T.bind("click",function(){t(this).prop("disabled")||o(f.getPrevPage(),!0)});var D=t("<button class='btn'><label>&gt;</label></button>");D.bind("click",function(){t(this).prop("disabled")||o(f.getNextPage(),!0)});var L=t("<button class='btn'><label>&gt;&gt;</label></button>");L.bind("click",function(){t(this).prop("disabled")||o(f.getLastPage(),!0)}),u.append(_),u.append(y),u.append(T),u.append(I),u.append(D),u.append(L)}else u.addClass("table-footer-nopage");if(r.append(u),t.extend(this,{addRows:function(e){f.addItems(e),p.showPage?l.children("div").length<f.m_iPerPage&&o(f.getCurrentPageItems()):o(f.m_aItems),p.showPage&&n()},deleteRows:function(){l.empty(),f.clear(),p.showPage&&n(),p.showCheckbox&&s.find(":checkbox").eq(0).prop("checked",!1),a()},getCheckedRows:function(){var e=[];return l.children("div").each(function(i){t(this).find(":checkbox").eq(0).prop("checked")&&(p.showPage&&f.m_iCurPage>0&&(i+=(f.m_iCurPage-1)*f.m_iPerPage),e.push({item:t(this),data:f.m_aItems[i].concat()}))}),e},getSelectedRow:function(){var e=l.find("div").filter(".table-select").eq(0);return 0===e.length?null:{item:e,data:f.m_aItems[e.index()].concat()}},getAllRows:function(){var e=[];return l.children("div").each(function(i){e.push({item:t(this),data:f.m_aItems[i].concat()})}),e},disable:function(e){e?u.addClass("disabled"):u.removeClass("disabled"),r.find(":text").prop("disabled",e),d=e},disableRow:function(e){l.find("div.table-row").eq(e).find(":input").prop("disabled",!0)},hideButton:function(e){l.find("div.table-row").eq(e).find(":button").hide()},showButton:function(e){l.find("div.table-row").eq(e).find(":button").show()}}),r.resize(function(){a();var e=0;b=s.width()-2-S,p.showCheckbox&&(b-=h+1,e++),p.showIndex&&(b-=g+1,e++);var i=e,n=!1;if(t.each(p.header,function(e){"data"!==p.header[e].type&&(i++,""!==p.header[e].percentWidth&&(p.header[e].width=Math.floor(parseInt(p.header[e].percentWidth,10)*b/100)+"",n=!0))}),n&&(s.find("span").each(function(i){e>i||t(this).width(p.header[i-e].width)}),l.find("span").each(function(n){n%=i,e>n||t(this).width(p.header[n-e].width)}),c.find("span").each(function(i){e>i||t(this).width(p.header[i-e].width)})),p.showPage&&0===p.perPage){var d=r.height()-s.outerHeight(!0)-u.outerHeight(!0),m=Math.floor(d/P);f.m_iPerPage!==m&&(f.setPerPage(m),l.children("div").length!==f.m_iPerPage&&o(f.getCurrentPageItems()))}}),a(),p.showPage)if(n(),0!==p.perPage)f.setPerPage(p.perPage);else{var x=r.height()-s.outerHeight(!0)-u.outerHeight(!0);f.setPerPage(Math.floor(x/P))}return m}}(t)});