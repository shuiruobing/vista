define(function(require,exports,module){function e(){u=null,_oLevelPermissionCapList={bRemoteSetParam:!1,bRemoteLog:!1,bRemoteUpgrade:!1,bRemoteTalk:!1,bRemoteReboot:!1,bRemoteAlarm:!1,bRemoteCtrl:!1,bRemoteRS:!1,bRemoteIPCCfg:!1,bRemotePreview:!1,bRemoteManualRecord:!1,bRemotePTZControl:!1,bRemotePlayback:!1},_oLevelPermissionCap={admin:{},viewer:{},operator:{}},m={bLocal:!0,bRemoteIPCCfg:!1,bLocalIPCCfg:!1},p=32,S={bAdd:!1,bModify:!1,bDelete:!1},b={Administrator:a.getValue("administrator"),Operator:a.getValue("operator"),Viewer:a.getValue("user")},I={admin:"Administrator",operator:"Operator",viewer:"Viewer"},y={Administrator:"admin",Operator:"operator",Viewer:"viewer"},_=""}var t,n,a,i,o,r,s,l,d,c,u,m,p,g,f,h,v,S,b,P,C,_,y,I,T;t=require("jquery"),require("config/ui.config"),require("ui.table"),n=require("common"),a=require("translator"),i=require("utils"),o=require("lib/dialog"),r=require("lib/base64"),s=require("webSession"),l=require("isapi/response"),d=require("config/service"),e.prototype={init:function(){var e=this;e.initParams(),e.initTable(),e.initController()},initParams:function(){var e=this;C={},e.initChannel(C,!1),e.initUserInfo()},initChannel:function(e,n){t.each(d.m_aAnalogChannelId,function(){e[this]=n}),t.each(d.m_aDigitalChannelId,function(){e[this]=n})},initUserInfo:function(){v={szUsername:"",szUserType:"",oPassword:{},oLocalPermission:{bLocalUpgrade:!1,bLocalReboot:!1,bLocalSetParam:!1,bLocalLog:!1,bLocalIPCCfg:!1,oLocalPlayback:{bChecked:!0,oChannel:{}},oLocalManualRecord:{bChecked:!0,oChannel:{}},oLocalPTZControl:{bChecked:!0,oChannel:{}},oLocalBackup:{bChecked:!0,oChannel:{}}},oRemotePermission:{bRemoteSetParam:!1,bRemoteLog:!1,bRemoteUpgrade:!1,bRemoteTalk:!1,bRemoteReboot:!1,bRemoteAlarm:!1,bRemoteCtrl:!1,bRemoteRS:!1,bRemoteIPCCfg:!1,oRemotePreview:{bChecked:!0,oChannel:{}},oRemoteManualRecord:{bChecked:!0,oChannel:{}},oRemotePTZControl:{bChecked:!0,oChannel:{}},oRemotePlayback:{bChecked:!0,oChannel:{}}},szSelPermission:"",bShowChannel:!1,bAdmin:!1,bUserType:!1,bDisableChannel:!1}},initController:function(){var e=this;angular.module("userManageApp",["ui.config"]).controller("userManageController",function($scope,$timeout,$compile){c=$scope,$scope.oLan=a.oLastLanguage,e.inputValid(),$scope.oBtnDisabled=S,$scope.oPermissionCap=m,$scope.oLevelPermissionCap={},$scope.aAnalog=d.m_aAnalogChannelId,$scope.aDigital=d.m_aDigitalChannelId,$scope.iAnalogNum=d.m_iAnalogChannelNum,$scope.oUserInfo=v,$scope.oAllChannel=C,$scope.bSelAllChannel=!1,$scope.bSelAllPermission=!1,$scope.bSecurityVersion=WebSDK.iSecurityVersion>0,$scope.select=function(e,n,a){var i=e.currentTarget;if(v.szSelPermission=angular.isDefined(a)?a:"",t(i).siblings(".item").removeClass("bg"),t(i).addClass("bg"),v.bShowChannel=n,""!=v.szSelPermission){var o=v.oLocalPermission[v.szSelPermission]&&v.oLocalPermission[v.szSelPermission].oChannel||v.oRemotePermission[v.szSelPermission].oChannel;if(t.extend(C,o),t(e.target).hasClass("checkbox"))for(var r in C)C[r]=t(e.target).prop("checked")}if(t(e.target).hasClass("checkbox")){var s=!0;t(i).parent().find(".checkbox").each(function(){return t(this).prop("checked")?void 0:(s=!1,!1)}),$scope.bSelAllPermission=s}$scope.oUserInfo.bDisableChannel=t(i).find(".checkbox[disabled]").length>0},$scope.selAllPermission=function(n){var a={},i=t(n.target).prop("checked");e.initChannel(a,i);var o="",r=[];t("#permissionList .checkbox:not(:disabled)").each(function(){o=t(this).attr("ng-model").replace(/\.bChecked/,"");var e=o.split(".");r.push(e[e.length-1])});for(var s in v.oLocalPermission)-1!==t.inArray(s,r)&&(angular.isObject(v.oLocalPermission[s])?(v.oLocalPermission[s].bChecked=i,t.extend(v.oLocalPermission[s].oChannel,a)):v.oLocalPermission[s]=i);for(var s in v.oRemotePermission)-1!==t.inArray(s,r)&&(angular.isObject(v.oRemotePermission[s])?(v.oRemotePermission[s].bChecked=i,t.extend(v.oRemotePermission[s].oChannel,a)):v.oRemotePermission[s]=i)},$scope.selAllChannel=function(e){for(var n in C)C[n]=t(e.target).prop("checked")},$scope.add=function(){T="add",e.add($compile)},$scope.modify=function(){T="modify",e.modify($compile)},$scope.deleteUser=function(){e.deleteUser()},$scope.$watch("oUserInfo.szUserType",function(n){$scope.bSelAllPermission=!1,e.changeUserType(n);var a=$scope.oLevelPermissionCap;t.each(a,function(e){a[e]=!1}),_oLevelPermissionCap[n]&&t.each(_oLevelPermissionCap[n],function(e){a[e]=!0}),$timeout(function(){v.bDisableChannel=t("#userDlg .permission").eq(0).find(".bg .checkbox[disabled]").length>0},10)}),$scope.$watch("oAllChannel",function(e){var n=!1,a=!0;for(var i in e)if(!e[i]){a=!1;break}for(var i in e)if(e[i]){n=!0;break}if($scope.bSelAllChannel=a,""!=v.szSelPermission){var o=v.oLocalPermission[v.szSelPermission]&&v.oLocalPermission[v.szSelPermission].oChannel||v.oRemotePermission[v.szSelPermission].oChannel;t.extend(o,C);var r=v.oLocalPermission[v.szSelPermission]||v.oRemotePermission[v.szSelPermission];r.bChecked=n}},!0),$timeout(function(){e.getPermissionCapa(),e.getUserInfo()},10)}),angular.bootstrap(angular.element("#userManage"),["userManageApp"])},inputValid:function(){c.oUtils=i,c.oInputValid={},c.aInputValidList=[],c.oInputValidUtils={},c.oUserameValid={oType:{value:"username"},oEmpty:{value:!1,error:a.getValue("nullTips")},oChinese:{value:!1,error:a.getValue("notZhChar")},oMaxLength:{value:32,error:a.getValue("noMoreLength",[32])}},c.username=function(){var e=!0,t="";return/[:\\\"]/.test(v.szUsername)&&(e=!1,t=a.getValue("notChar")+' \\ " : '),{bValid:e,szError:t}}},initTable:function(){var e=this;u=t("#tableUser").table({header:[{display:a.getValue("username"),width:"300"},{display:a.getValue("userLevel"),width:"354"}],lan:{index:a.getValue("serialNumber"),item:a.getValue("items"),total:a.getValue("total")},showIndex:!0,onSelect:function(t){e.onSelect(t)}})},changeUserType:function(e){if(e){var n=this;v.oLocalPermission.bLocalUpgrade=!1,v.oLocalPermission.bLocalReboot=!1,v.oLocalPermission.bLocalSetParam=!1,v.oLocalPermission.bLocalLog=!0,v.oLocalPermission.bLocalIPCCfg=!1,v.oLocalPermission.oLocalPlayback.bChecked=!0,v.oLocalPermission.oLocalManualRecord.bChecked=!1,v.oLocalPermission.oLocalPTZControl.bChecked=!1,v.oLocalPermission.oLocalBackup.bChecked=!1,v.oRemotePermission.bRemoteSetParam=!1,v.oRemotePermission.bRemoteLog=!0,v.oRemotePermission.bRemoteUpgrade=!1,v.oRemotePermission.bRemoteTalk=!1,v.oRemotePermission.bRemoteReboot=!1,v.oRemotePermission.bRemoteAlarm=!1,v.oRemotePermission.bRemoteCtrl=!1,v.oRemotePermission.bRemoteRS=!1,v.oRemotePermission.bRemoteIPCCfg=!1,v.oRemotePermission.oRemotePreview.bChecked=!1,v.oRemotePermission.oRemoteManualRecord.bChecked=!1,v.oRemotePermission.oRemotePTZControl.bChecked=!1,v.oRemotePermission.oRemotePlayback.bChecked=!0,n.initChannel(v.oLocalPermission.oLocalPlayback.oChannel,!0),n.initChannel(v.oLocalPermission.oLocalManualRecord.oChannel,!1),n.initChannel(v.oLocalPermission.oLocalPTZControl.oChannel,!1),n.initChannel(v.oLocalPermission.oLocalBackup.oChannel,!1),n.initChannel(v.oRemotePermission.oRemotePreview.oChannel,!1),n.initChannel(v.oRemotePermission.oRemoteManualRecord.oChannel,!1),n.initChannel(v.oRemotePermission.oRemotePTZControl.oChannel,!1),n.initChannel(v.oRemotePermission.oRemotePlayback.oChannel,!0),"operator"==e&&(v.oRemotePermission.bRemoteTalk=!0,v.oLocalPermission.oLocalManualRecord.bChecked=!0,v.oLocalPermission.oLocalPTZControl.bChecked=!0,v.oLocalPermission.oLocalBackup.bChecked=!0,v.oRemotePermission.oRemotePreview.bChecked=!0,v.oRemotePermission.oRemoteManualRecord.bChecked=!0,v.oRemotePermission.oRemotePTZControl.bChecked=!0,n.initChannel(v.oLocalPermission.oLocalManualRecord.oChannel,!0),n.initChannel(v.oLocalPermission.oLocalPTZControl.oChannel,!0),n.initChannel(v.oLocalPermission.oLocalBackup.oChannel,!0),n.initChannel(v.oRemotePermission.oRemotePreview.oChannel,!0),n.initChannel(v.oRemotePermission.oRemoteManualRecord.oChannel,!0),n.initChannel(v.oRemotePermission.oRemotePTZControl.oChannel,!0));var a=v.oRemotePermission;if(t.each(_oLevelPermissionCap[e],function(e,t){if(angular.isDefined(a[e]))a[e]=t;else{var i=e.replace(/b/,"o");a[i]&&(a[i].bChecked=t),("bRemotePreview"===e||"bRemoteManualRecord"===e||"bRemotePTZControl"===e||"bRemotePlayback"===e)&&n.initChannel(a[i].oChannel,t)}}),""!=v.szSelPermission){var i=v.oLocalPermission[v.szSelPermission]&&v.oLocalPermission[v.szSelPermission].oChannel||v.oRemotePermission[v.szSelPermission].oChannel;t.extend(C,i)}}},getPermissionCapa:function(){var e=this;t.each(_oLevelPermissionCap,function(t){e.getLevelPermissionCapa(t)})},getLevelPermissionCapa:function(e){var a=t.extend({},_oLevelPermissionCapList);"viewer"===e?t.extend(a,{bRemoteLog:!0,bRemotePlayback:!0}):"operator"===e?t.extend(a,{bRemoteLog:!0,bRemoteTalk:!0,bRemotePreview:!0,bRemoteManualRecord:!0,bRemotePTZControl:!0,bRemotePlayback:!0}):"admin"===e&&t.each(a,function(e){a[e]=!0}),t.extend(_oLevelPermissionCap[e],a),"admin"===e?WebSDK.WSDK_GetDeviceConfig(n.m_szHostName,"userPermission",{user:1},{success:function(e,n){0===t(n).find("localPermission").length&&(m.bLocal=!1),t(n).find("localPermission").length>0&&(m.bRemoteIPCCfg=!0)},error:function(){m.bLocal=!1}}):WebSDK.WSDK_GetDeviceConfig(n.m_szHostName,"userPermissionCap",{userType:e+"Cap"},{success:function(n,a){var o=_oLevelPermissionCap[e]={},r=t(a).find("UserPermissionCap remotePermissionCap").eq(0);i.nodeValue(r,"preview","b")&&(o.bRemotePreview=i.nodeAttr(r,"preview","def","b")),i.nodeValue(r,"ptzControl","b")&&(o.bRemotePTZControl=i.nodeAttr(r,"ptzControl","def","b")),i.nodeValue(r,"record","b")&&(o.bRemoteManualRecord=i.nodeAttr(r,"record","def","b")),i.nodeValue(r,"playBack","b")&&(o.bRemotePlayback=i.nodeAttr(r,"playBack","def","b")),i.nodeValue(r,"parameterConfig","b")&&(o.bRemoteSetParam=i.nodeAttr(r,"parameterConfig","def","b")),i.nodeValue(r,"restartOrShutdown","b")&&(o.bRemoteReboot=i.nodeAttr(r,"restartOrShutdown","def","b")),i.nodeValue(r,"upgrade","b")&&(o.bRemoteUpgrade=i.nodeAttr(r,"upgrade","def","b")),i.nodeValue(r,"logOrStateCheck","b")&&(o.bRemoteLog=i.nodeAttr(r,"logOrStateCheck","def","b")),i.nodeValue(r,"voiceTalk","b")&&(o.bRemoteTalk=i.nodeAttr(r,"voiceTalk","def","b")),i.nodeValue(r,"transParentChannel","b")&&(o.bRemoteRS=i.nodeAttr(r,"transParentChannel","def","b")),i.nodeValue(r,"contorlLocalOut","b")&&(o.bRemoteCtrl=i.nodeAttr(r,"contorlLocalOut","def","b")),i.nodeValue(r,"alarmOutOrUpload","b")&&(o.bRemoteAlarm=i.nodeAttr(r,"alarmOutOrUpload","def","b"))},error:function(){}})},getUserInfo:function(){var e=null;g=[],f=[],h=[],P=null,WebSDK.WSDK_GetDeviceConfig(n.m_szHostName,"user",null,{success:function(a,i){P=i,S.bModify=!0,S.bDelete=!0,e=t(i).find("User");var o=0;t.each(e,function(){("admin"===n.m_szUsername||t(this).find("userName").eq(0).text()==n.m_szUsername)&&(g[o]=[],g[o][0]=t(this).find("userName").eq(0).text(),g[o][1]=b[t(this).find("userLevel").eq(0).text()],f[o]=t(this).find("id").eq(0).text(),h[o]=t(this).find("userLevel").eq(0).text(),o++)}),u.deleteRows(),u.addRows(g),S.bAdd=e.length>=p||"admin"!=n.m_szUsername?!0:!1,c.$apply()},error:function(e,t,n){l.getState(n)}})},onSelect:function(e){S.bModify=!1,S.bDelete=g[e][0]==n.m_szUsername?!0:!1,c.$apply()},add:function($compile){var e=this;v.bShowChannel=!1,v.szUsername="",v.szUserType="operator",v.bAdmin=!1,v.bUserType=!1,v.bDisableChannel=!1,c.bSelAllPermission=!1,e.changeUserType(v.szUserType),t.get("config/system/userDlg.js",function(n){o.html(a.getValue("addUser"),n,null,null,function(){return e.addOk("add")},function(){},function(){c.oInputValidUtils.clearInputValidList(),i.removeValidTip()}),$compile(angular.element("#userDlg"))(c),c.$apply(),artDialog.get("dialoghtml").position(artDialog.defaults.left,artDialog.defaults.top),t("#userDlg").hide().show()})},addOk:function(e){var d=this,m=-1,p="",h=null;if(c.oInputValidUtils.manualInputValid(),!c.oInputValid.bInputValid)return!1;"modify"==e&&(m=u.getSelectedRow().item.index());for(var S=0;g.length>S;S++)if(("modify"!=e||m!=S)&&g[S][0]==v.szUsername)return o.alert(a.getValue("userExist")),!1;"add"==e?(p="<?xml version='1.0' encoding='UTF-8'?>",p+="<User><id>0</id><userName>"+i.encodeString(v.szUsername)+"</userName>",c.bSecurityVersion,p+="<password>"+i.encodeString(v.oPassword.szPassword)+"</password>",p+="<bondIpList><bondIp><id>1</id><ipAddress>0.0.0.0</ipAddress><ipv6Address>::</ipv6Address></bondIp></bondIpList><macAddress></macAddress>",p+="<userLevel>"+I[v.szUserType]+"</userLevel>",p+="<attribute><inherent>false</inherent></attribute>",p+="</User>",h=i.parseXmlFromStr(p),WebSDK.WSDK_SetDeviceConfig(n.m_szHostName,"user",null,{data:h,success:function(e,n){d.setUserPermission(t(n).find("id").eq(0).text())},error:function(e,t,n){l.saveState(n)}})):(p="<?xml version='1.0' encoding='UTF-8'?>",p+="<User><id>"+f[m]+"</id><userName>"+i.encodeString(v.szUsername)+"</userName>",v.oPassword.szPassword!==_&&(p+="<password>"+i.encodeString(v.oPassword.szPassword)+"</password>"),p+="<bondIpList><bondIp><id>1</id><ipAddress>0.0.0.0</ipAddress><ipv6Address>::</ipv6Address></bondIp></bondIpList><macAddress></macAddress>",p+="<userLevel>"+I[v.szUserType]+"</userLevel>",p+="<attribute><inherent>"+t(P).find("User").eq(m).find("inherent").eq(0).text()+"</inherent></attribute>",p+="</User>",h=i.parseXmlFromStr(p),WebSDK.WSDK_SetDeviceConfig(n.m_szHostName,"userModify",{user:f[m]},{data:h,success:function(e,t,a){if(v.oPassword.szPassword!==_&&v.szUsername===n.m_szUsername){var o=r.encode(n.m_szUsername+":"+v.oPassword.szPassword);n.m_szNamePwd=o,n.m_bSession&&(o=i.encodeAES(o,MD5(n.m_szSessionId)),o=r.encode(o)),s.setItem("userInfo",o),n.changeNamePWD(n.m_bAnonymous,n.m_szUsername,v.oPassword.szPassword),WebSDK.WSDK_SetLoginInfo(n.m_szHostName,n.m_iHttpProtocal,n.m_iHttpPort,n.m_szUsername,v.oPassword.szPassword,{sessionId:n.m_szSessionId})}"admin"===n.m_szUsername&&"admin"!=v.szUsername?d.setUserPermission(f[m]):(l.saveState(a),d.getUserInfo())},error:function(e,t,r){return"loginPasswordError"===i.nodeValue(t,"subStatusCode")?(v.szUsername===n.m_szUsername?o.alert(a.getValue("oldPwdError")):o.alert(a.getValue("adminPwdError")),!1):(l.saveState(r),void 0)}}))},setUserPermission:function(e){var t=this,a="",o=null;if(a="<?xml version='1.0' encoding='utf-8'?>",a+="<UserPermission><id>"+e+"</id><userID>"+e+"</userID>",a+="<userType>"+v.szUserType+"</userType>",m.bLocal){a+="<localPermission>",a+="<upgrade>"+(""+v.oLocalPermission.bLocalUpgrade)+"</upgrade>",a+="<parameterConfig>"+(""+v.oLocalPermission.bLocalSetParam)+"</parameterConfig>",a+="<restartOrShutdown>"+(""+v.oLocalPermission.bLocalReboot)+"</restartOrShutdown>",a+="<logOrStateCheck>"+(""+v.oLocalPermission.bLocalLog)+"</logOrStateCheck>",m.bLocalIPCCfg&&(a+="<manageChannel>"+(""+v.oLocalPermission.bLocalIPCCfg)+"</manageChannel>"),a+="<playBack>"+(""+v.oLocalPermission.oLocalPlayback.bChecked)+"</playBack>",a+="<record>"+(""+v.oLocalPermission.oLocalManualRecord.bChecked)+"</record>",a+="<ptzControl>"+(""+v.oLocalPermission.oLocalPTZControl.bChecked)+"</ptzControl>",a+="<backup>"+(""+v.oLocalPermission.oLocalBackup.bChecked)+"</backup>",a+="<videoChannelPermissionList>";for(var r in C)a+="<videoChannelPermission>",a+="<id>"+r+"</id>",a+="<playBack>"+(""+v.oLocalPermission.oLocalPlayback.oChannel[r])+"</playBack>",a+="<record>"+(""+v.oLocalPermission.oLocalManualRecord.oChannel[r])+"</record>",a+="<backup>"+(""+v.oLocalPermission.oLocalBackup.oChannel[r])+"</backup>",a+="</videoChannelPermission>";a+="</videoChannelPermissionList>",a+="<ptzChannelPermissionList>";for(var r in C)a+="<ptzChannelPermission>",a+="<id>"+r+"</id>",a+="<ptzControl>"+(""+v.oLocalPermission.oLocalPTZControl.oChannel[r])+"</ptzControl>",a+="</ptzChannelPermission>";a+="</ptzChannelPermissionList>",a+="</localPermission>"}a+="<remotePermission>",a+="<parameterConfig>"+(""+v.oRemotePermission.bRemoteSetParam)+"</parameterConfig>",a+="<logOrStateCheck>"+(""+v.oRemotePermission.bRemoteLog)+"</logOrStateCheck>",a+="<upgrade>"+(""+v.oRemotePermission.bRemoteUpgrade)+"</upgrade>",a+="<voiceTalk>"+(""+v.oRemotePermission.bRemoteTalk)+"</voiceTalk>",a+="<restartOrShutdown>"+(""+v.oRemotePermission.bRemoteReboot)+"</restartOrShutdown>",a+="<alarmOutOrUpload>"+(""+v.oRemotePermission.bRemoteAlarm)+"</alarmOutOrUpload>",a+="<contorlLocalOut>"+(""+v.oRemotePermission.bRemoteCtrl)+"</contorlLocalOut>",a+="<transParentChannel>"+(""+v.oRemotePermission.bRemoteRS)+"</transParentChannel>",m.bRemoteIPCCfg&&(a+="<manageChannel>"+(""+v.oRemotePermission.bRemoteIPCCfg)+"</manageChannel>"),a+="<preview>"+(""+v.oRemotePermission.oRemotePreview.bChecked)+"</preview>",a+="<record>"+(""+v.oRemotePermission.oRemoteManualRecord.bChecked)+"</record>",a+="<ptzControl>"+(""+v.oRemotePermission.oRemotePTZControl.bChecked)+"</ptzControl>",a+="<playBack>"+(""+v.oRemotePermission.oRemotePlayback.bChecked)+"</playBack>",a+="<videoChannelPermissionList>";for(var r in C)a+="<videoChannelPermission>",a+="<id>"+r+"</id>",a+="<preview>"+(""+v.oRemotePermission.oRemotePreview.oChannel[r])+"</preview>",a+="<record>"+(""+v.oRemotePermission.oRemoteManualRecord.oChannel[r])+"</record>",a+="<playBack>"+(""+v.oRemotePermission.oRemotePlayback.oChannel[r])+"</playBack>",a+="</videoChannelPermission>";a+="</videoChannelPermissionList>",a+="<ptzChannelPermissionList>";for(var r in C)a+="<ptzChannelPermission>",a+="<id>"+r+"</id>",a+="<ptzControl>"+(""+v.oRemotePermission.oRemotePTZControl.oChannel[r])+"</ptzControl>",a+="</ptzChannelPermission>";a+="</ptzChannelPermissionList>",a+="</remotePermission></UserPermission>",o=i.parseXmlFromStr(a),WebSDK.WSDK_SetDeviceConfig(n.m_szHostName,"userPermission",{user:e},{data:o,success:function(e,n,a){l.saveState(a),t.getUserInfo()},error:function(e,t,n){l.saveState(n)}})},modify:function($compile){var e=this,r=null;if(v.bShowChannel=!1,r=u.getSelectedRow(),null!=r.item){var s=r.item.index();v.szUsername=g[s][0],v.szUserType=y[h[s]],v.bAdmin=!1,v.bUserType=!1,v.bDisableChannel=!1,"admin"===v.szUserType?(v.bAdmin=!0,v.bUserType=!0):v.szUsername==n.m_szUsername&&(v.bUserType=!0),t.get("config/system/userDlg.js",function(n){v.oPassword.szOldPassword="",o.html(a.getValue("modifyUser"),n,null,500,function(){return e.addOk("modify")},function(){},function(){c.oInputValidUtils.clearInputValidList(),i.removeValidTip()}),e.getUserPermission(f[s]),$compile(angular.element("#userDlg"))(c),c.$apply(),artDialog.get("dialoghtml").position(artDialog.defaults.left,artDialog.defaults.top),t("#userDlg").hide().show()})}},getUserPermission:function(e){var a=null,o=null,r=0;c.bSelAllPermission=!1,WebSDK.WSDK_GetDeviceConfig(n.m_szHostName,"userPermission",{user:e},{success:function(e,n){a=t(n).find("localPermission").eq(0),v.oLocalPermission.bLocalUpgrade=i.nodeValue(a,"upgrade","b"),v.oLocalPermission.bLocalReboot=i.nodeValue(a,"restartOrShutdown","b"),v.oLocalPermission.bLocalSetParam=i.nodeValue(a,"parameterConfig","b"),v.oLocalPermission.bLocalLog=i.nodeValue(a,"logOrStateCheck","b"),a.find("manageChannel").length>0?(m.bLocalIPCCfg=!0,v.oLocalPermission.bLocalIPCCfg=i.nodeValue(a,"manageChannel","b")):(m.bLocalIPCCfg=!1,v.oLocalPermission.bLocalIPCCfg=!1),v.oLocalPermission.oLocalPlayback.bChecked=i.nodeValue(a,"playBack","b"),v.oLocalPermission.oLocalManualRecord.bChecked=i.nodeValue(a,"record","b"),v.oLocalPermission.oLocalPTZControl.bChecked=i.nodeValue(a,"ptzControl","b"),v.oLocalPermission.oLocalBackup.bChecked=i.nodeValue(a,"backup","b"),a.find("videoChannelPermission").each(function(){r=i.nodeValue(this,"id","i"),v.oLocalPermission.oLocalPlayback.oChannel[r]=i.nodeValue(this,"playBack","b"),v.oLocalPermission.oLocalManualRecord.oChannel[r]=i.nodeValue(this,"record","b"),v.oLocalPermission.oLocalBackup.oChannel[r]=i.nodeValue(this,"backup","b")}),a.find("ptzChannelPermission").each(function(){r=i.nodeValue(this,"id","i"),v.oLocalPermission.oLocalPTZControl.oChannel[r]=i.nodeValue(this,"ptzControl","b")}),o=t(n).find("remotePermission").eq(0),v.oRemotePermission.bRemoteSetParam=i.nodeValue(o,"parameterConfig","b"),v.oRemotePermission.bRemoteLog=i.nodeValue(o,"logOrStateCheck","b"),v.oRemotePermission.bRemoteUpgrade=i.nodeValue(o,"upgrade","b"),v.oRemotePermission.bRemoteTalk=i.nodeValue(o,"voiceTalk","b"),v.oRemotePermission.bRemoteReboot=i.nodeValue(o,"restartOrShutdown","b"),v.oRemotePermission.bRemoteAlarm=i.nodeValue(o,"alarmOutOrUpload","b"),v.oRemotePermission.bRemoteCtrl=i.nodeValue(o,"contorlLocalOut","b"),v.oRemotePermission.bRemoteRS=i.nodeValue(o,"transParentChannel","b"),v.oRemotePermission.bRemoteIPCCfg=o.find("manageChannel").length>0?i.nodeValue(o,"manageChannel","b"):!1,v.oRemotePermission.oRemotePreview.bChecked=i.nodeValue(o,"preview","b"),v.oRemotePermission.oRemoteManualRecord.bChecked=i.nodeValue(o,"record","b"),v.oRemotePermission.oRemotePTZControl.bChecked=i.nodeValue(o,"ptzControl","b"),v.oRemotePermission.oRemotePlayback.bChecked=i.nodeValue(o,"playBack","b"),o.find("videoChannelPermission").each(function(){r=i.nodeValue(this,"id","i"),v.oRemotePermission.oRemotePreview.oChannel[r]=i.nodeValue(this,"preview","b"),v.oRemotePermission.oRemoteManualRecord.oChannel[r]=i.nodeValue(this,"record","b"),v.oRemotePermission.oRemotePlayback.oChannel[r]=i.nodeValue(this,"playBack","b")}),o.find("ptzChannelPermission").each(function(){r=i.nodeValue(this,"id","i"),v.oRemotePermission.oRemotePTZControl.oChannel[r]=i.nodeValue(this,"ptzControl","b")}),c.$apply(),0==t("#userDlg .permission").eq(0).find(".checkbox").not(":first").not(":checked").length&&(c.bSelAllPermission=!0,c.$apply())}})},deleteUser:function(){var e=this,t=null;t=u.getSelectedRow(),null!=t.item&&o.confirm(a.getValue("deleteUser"),null,function(){WebSDK.WSDK_SetDeviceConfig(n.m_szHostName,"userDelete",{user:f[t.item.index()]},{success:function(t,n,a){l.saveState(a,null,1),e.getUserInfo()},error:function(e,t,n){l.saveState(n)}})})}},module.exports=new e});